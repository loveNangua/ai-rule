# GitHub Actions 工作流名称
name: Merge AI Surge Rules

# 触发工作流的条件
on:
  workflow_dispatch:
  schedule:
    - cron: '0 21 * * *'

# 定义工作任务
jobs:
  merge-rules:
    runs-on: ubuntu-latest

    # =============================================================== #
    # V V V V V V V V V V  添加下面这一段来授予权限  V V V V V V V V V V V #
    permissions:
      contents: write
    # A A A A A A A A A A  只需添加上面这一段即可  A A A A A A A A A A A #
    # =============================================================== #

    steps:
      # 第一步：检出（Checkout）你的仓库代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 第二步：下载并合并指定的AI规则
      - name: Merge AI rule files
        run: |
          echo "# AI Rules for Surge (OpenAI, Gemini, Copilot, Anthropic)" > AI.list
          echo "# Generated by GitHub Actions" >> AI.list
          echo "# Last Updated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> AI.list
          echo "" >> AI.list

          urls=(
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/OpenAI/OpenAI.list"
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Gemini/Gemini.list"
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Copilot/Copilot.list"
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Claude/Claude.list"
          )

          for url in "${urls[@]}"; do
            echo "Fetching from ${url}"
            curl -sS Lf "$url" >> AI.list
            echo "" >> AI.list
          done
          
          echo "AI规则合并完成！"

      # 第三步：自动将生成的新文件提交回你的仓库
      - name: Commit and push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "feat: ✨ 自动更新AI规则"
          file_pattern: AI.list
