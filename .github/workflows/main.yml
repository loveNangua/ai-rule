# GitHub Actions 工作流名称
name: Merge AI Surge Rules

# 触发工作流的条件
on:
  # 1. 允许您在 Actions 页面手动点击 "Run workflow" 按钮来立即执行
  workflow_dispatch:

  # 2. 定时触发：每天北京时间早上5点执行一次
  schedule:
    - cron: '0 21 * * *' # UTC时间 21:00, 对应北京时间 05:00

# 定义工作任务
jobs:
  merge-rules:
    # 使用最新的 Ubuntu 虚拟机环境
    runs-on: ubuntu-latest

    # 工作步骤
    steps:
      # 第一步：检出（Checkout）你的仓库代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 第二步：下载并合并指定的四个核心AI规则
      - name: Merge AI rule files
        run: |
          # 创建一个名为 AI.list 的新文件，并写入注释头
          echo "# AI Rules for Surge (OpenAI, Gemini, Copilot, Anthropic)" > AI.list
          echo "# Generated by GitHub Actions" >> AI.list
          echo "# Last Updated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> AI.list
          echo "" >> AI.list

          # 定义一个只包含您需要的四个规则链接的数组
          urls=(
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/OpenAI/OpenAI.list"
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Gemini/Gemini.list"
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Copilot/Copilot.list"
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Claude/Claude.list"
          )

          # 遍历数组，下载每个URL的内容并追加到最终文件中
          for url in "${urls[@]}"; do
            echo "Fetching from ${url}"
            # 使用 curl 下载并追加到 AI.list
            curl -sS Lf "$url" >> AI.list
            # 在每个文件末尾添加一个换行，避免文件粘连
            echo "" >> AI.list
          done
          
          echo "AI规则合并完成！"

      # 第三步：自动将生成的新文件提交回你的仓库
      - name: Commit and push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # 提交信息
          commit_message: "feat: ✨ 自动更新AI规则"
          # 要提交的文件名，已修改为 AI.list
          file_pattern: AI.list

